<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Member Card</title>

<style>
body {
  margin: 0;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  background: #f2f2f2;
  font-family: sans-serif;
}

.card-wrap {
  text-align: center;
}

#loading {
  margin-bottom: 12px;
  opacity: .7;
}

.card {
  position: relative;
  width: 360px;
  max-width: 90vw;
  border-radius: 18px;
  overflow: hidden;
  box-shadow: 0 14px 32px rgba(0,0,0,.15);
  filter: blur(8px);
  opacity: .6;
  transition: all .5s ease;
  font-size: clamp(14px, 2.5vw, 18px);
}

.card.loaded {
  filter: blur(0);
  opacity: 1;
}

.card img {
  width: 100%;
  display: block;
}

.field {
  position: absolute;
  left: 30px;
  color: #222;
  opacity: 0;
  transform: translateY(6px);
  transition: all .4s ease;
  transform: translateY(6px);
  transition: all .4s ease;
  transform: translateY(-50%);
}


.field.show {
  opacity: 1;
  opacity .4s ease,
    transform .25s ease,
    top .25s ease,
    left .25s ease;
  transform: translateY(0);
}

/* ===== layout ===== */
.name-kr {
  top: 29%;
  left: 30%;
  font-size: 1.2em;
  font-weight: bold;
  max-width: 40%;
  white-space: nowrap;
}

.name-en {
  top: 31%;
  left: 50%;
  font-size: 1.2em;
  font-weight: bold;
  max-width: 40%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.birth {
  top: 51%;
  left: 40%;
  font-size: 0.9em;
}

.join {
  top: 70%;
  left: 24.5%;
  font-size: 0.9em;
}

.expire {
  top: 70%;
  left: 72.5%;
  font-size: 0.9em;
}


/* ===== status ===== */
.status {
  position: absolute;
  top: 33px;
  right: 20px;
  padding: 4px 12px;
  font-size: 12px;
  border-radius: 20px;
  color: #fff;
  font-weight: bold;
  opacity: 0;
  transition: opacity .4s ease;
}

.status.active  { background: #22c55e; }
.status.expired { background: #ef4444; }
.status.show    { opacity: 1; }
</style>
</head>

<body>

<div class="card-wrap">
  <div id="loading">กำลังโหลดข้อมูล...</div>

  <div class="card" id="card">
    <img src="card_v1.png">
    <div id="status" class="status"></div>

    <div id="nameKr" class="field name-kr"></div>
    <div id="nameEn" class="field name-en"></div>
    <div id="birth"  class="field birth"></div>
    <div id="join"   class="field join"></div>
    <div id="expire" class="field expire"></div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const csvUrl =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vTH3k49gzRtNcKd8E32h5hz0rWkh3wKUkkPymfAh4NDtg0YZogVaCIV2YH8Ly68Gqhx7Fw6f4_UlGRj/pub?output=csv";

/* ===== HELPERS ===== */
function parseDateSafe(value) {
  if (!value) return null;
  const clean = value.replace(/"/g, "").trim();
  const d = new Date(clean + "T00:00:00");
  return isNaN(d) ? null : d;
}

function formatDateOnly(value) {
  const d = parseDateSafe(value);
  if (!d) return "";
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

/* ===== MAIN ===== */
const params = new URLSearchParams(window.location.search);
const memberId = params.get("id");

if (!memberId) {
  document.body.innerHTML = "<h2>ไม่พบรหัสสมาชิก</h2>";
} else {

fetch(csvUrl)
  .then(r => {
    if (!r.ok) throw new Error();
    return r.text();
  })
  .then(text => {

    const rows = text.trim().split("\n").map(r =>
      r.split(",").map(c => c.replace(/(^"|"$)/g,"").trim())
    );

    const headers = rows[0].map(h => h.toLowerCase());
    const data = rows.slice(1);

    const idIndex     = headers.indexOf("id");
    const krIndex     = headers.indexOf("name_kr");
    const enIndex     = headers.indexOf("name_en");
    const birthIndex  = headers.indexOf("birth_date");
    const joinIndex   = headers.indexOf("join_date");
    const expireIndex = headers.indexOf("expire_date");

    const member = data.find(row =>
      row[idIndex].replace(/^0+/,"") === memberId.replace(/^0+/,"")
    );

    if (!member) {
      document.body.innerHTML = "<h2>ไม่พบข้อมูลสมาชิก</h2>";
      return;
    }

    document.getElementById("nameKr").innerText = member[krIndex];
    document.getElementById("nameEn").innerText = member[enIndex];
    document.getElementById("birth").innerText  = formatDateOnly(member[birthIndex]);
    document.getElementById("join").innerText   = formatDateOnly(member[joinIndex]);
    document.getElementById("expire").innerText = formatDateOnly(member[expireIndex]);

    const today = new Date();
    today.setHours(0,0,0,0);
    const expireDate = parseDateSafe(member[expireIndex]);

    const status = document.getElementById("status");
    if (expireDate && expireDate >= today) {
      status.innerText = "ACTIVE";
      status.className = "status active show";
    } else {
      status.innerText = "EXPIRED";
      status.className = "status expired show";
    }

    document.getElementById("loading").style.display = "none";

    setTimeout(() => {
      document.getElementById("card").classList.add("loaded");
      document.querySelectorAll(".field")
        .forEach(el => el.classList.add("show"));
    }, 300);
  })
  .catch(() => {
    document.body.innerHTML = "<h2>โหลดข้อมูลไม่สำเร็จ</h2>";
  });

}
</script>

</body>
</html>
