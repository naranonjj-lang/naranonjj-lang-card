<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Member Card</title>

<style>
body {
  margin: 0;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  background: #f2f2f2;
  font-family: sans-serif;
}

.card-wrap {
  text-align: center;
}

#loading {
  margin-bottom: 12px;
  opacity: .7;
}

/* ===== CARD ===== */
.card {
  position: relative;
  width: 360px;
  border-radius: 18px;
  overflow: hidden;
  box-shadow: 0 14px 32px rgba(0,0,0,.15);
  filter: blur(8px);
  opacity: .6;
  transition: filter .5s ease, opacity .5s ease, transform .3s ease;
  transform-origin: center;
  background: #fff;
}

.card.loaded {
  filter: blur(0);
  opacity: 1;
}

.card img {
  width: 100%;
  display: block;
}

/* ===== TEXT FIELDS ===== */
.field {
  position: absolute;
  color: #222;
  opacity: 0;
  transform: translateY(6px);
  transition: opacity .4s ease, transform .4s ease;
  white-space: nowrap;
}

.field.show {
  opacity: 1;
  transform: translateY(0);
}

/* ===== layout ===== */
.name-kr {
  top: 29%;
  left: 30%;
  font-size: 18px;
  font-weight: bold;
  max-width: 40%;
}

.name-en {
  top: 31%;
  left: 50%;
  font-size: 18px;
  font-weight: bold;
  max-width: 40%;
  overflow: hidden;
  text-overflow: ellipsis;
}

.birth {
  top: 51%;
  left: 40%;
  font-size: 14px;
}

.join {
  top: 70%;
  left: 24.5%;
  font-size: 14px;
}

.expire {
  top: 70%;
  left: 72.5%;
  font-size: 14px;
}

/* ===== status ===== */
.status {
  position: absolute;
  top: 18px;
  right: 16px;
  padding: 4px 12px;
  font-size: 12px;
  border-radius: 20px;
  color: #fff;
  font-weight: bold;
  opacity: 0;
  transition: opacity .4s ease;
}

.status.active  { background: #22c55e; }
.status.expired { background: #ef4444; }
.status.show    { opacity: 1; }

/* ===== MOBILE SCALE ===== */
@media (max-width: 420px) {
  .card {
    transform: scale(0.9);
  }
}

@media (max-width: 360px) {
  .card {
    transform: scale(0.85);
  }
}
</style>
</head>

<body>

<div class="card-wrap">
  <div id="loading">กำลังโหลดข้อมูล...</div>

  <div class="card" id="card">
    <img src="card_v1.png">
    <div id="status" class="status"></div>

    <div id="nameKr" class="field name-kr"></div>
    <div id="nameEn" class="field name-en"></div>
    <div id="birth"  class="field birth"></div>
    <div id="join"   class="field join"></div>
    <div id="expire" class="field expire"></div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const csvUrl =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vTH3k49gzRtNcKd8E32h5hz0rWkh3wKUkkPymfAh4NDtg0YZogVaCIV2YH8Ly68Gqhx7Fw6f4_UlGRj/pub?output=csv";

/* ===== HELPERS ===== */
function parseDateSafe(value) {
  if (!value) return null;
  const d = new Date(value + "T00:00:00");
  return isNaN(d) ? null : d;
}

function formatDateOnly(value) {
  const d = parseDateSafe(value);
  if (!d) return "";
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}

/* ===== MAIN ===== */
const params = new URLSearchParams(window.location.search);
const memberId = params.get("id");

if (!memberId) {
  document.body.innerHTML = "<h2>ไม่พบรหัสสมาชิก</h2>";
} else {

fetch(csvUrl)
  .then(r => r.text())
  .then(text => {

    const rows = text.trim().split("\n").map(r =>
      r.split(",").map(c => c.replace(/(^"|"$)/g,"").trim())
    );

    const headers = rows[0].map(h => h.toLowerCase());
    const data = rows.slice(1);

    const member = data.find(row =>
      row[headers.indexOf("id")].replace(/^0+/,"") === memberId.replace(/^0+/,"")
    );

    if (!member) {
      document.body.innerHTML = "<h2>ไม่พบข้อมูลสมาชิก</h2>";
      return;
    }

    nameKr.innerText = member[headers.indexOf("name_kr")];
    nameEn.innerText = member[headers.indexOf("name_en")];
    birth.innerText  = formatDateOnly(member[headers.indexOf("birth_date")]);
    join.innerText   = formatDateOnly(member[headers.indexOf("join_date")]);
    expire.innerText = formatDateOnly(member[headers.indexOf("expire_date")]);

    const today = new Date();
    today.setHours(0,0,0,0);
    const expireDate = parseDateSafe(member[headers.indexOf("expire_date")]);

    if (expireDate && expireDate >= today) {
      status.innerText = "ACTIVE";
      status.className = "status active show";
    } else {
      status.innerText = "EXPIRED";
      status.className = "status expired show";
    }

    loading.style.display = "none";

    setTimeout(() => {
      card.classList.add("loaded");
      document.querySelectorAll(".field").forEach(el => el.classList.add("show"));
    }, 300);
  });
}
</script>

</body>
</html>
